<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Скопируй всё из документа и экспортируй в .md файл.

Вот содержимое в формате Markdown, его можно сохранить как `capitalist.merchant.md`:

```markdown
Магазины  
v.1.11 от 16.06.2023  
Скачать свежую версию этой документации можно по адресу https://docs.capitalist.net/api/merchant/capitalist.merchant.pdf  
English version: https://docs.capitalist.net/api/merchant/en_capitalist.merchant.pdf  

Инструкция по подключению  

Требования  
Для подключения платежной системы к своему сайту необходимо иметь аккаунт в Capitalist.net.  
Если у вас еще нет аккаунта, зарегистрируйтесь по адресу https://capitalist.net/reg.  

Создание магазина  
Перед заполнением формы, приготовьтесь загрузить проверочный файл на свой сайт (см. второй шаг).  
В основном меню выберите пункт «Добавить магазин» или пройдите по адресу https://capitalist.net/merchants/add.  

Шаг 1: Ввод названия, домена  
- Название магазина может содержать до 60 знаков. Будет видно пользователям.  
- Доменое имя вашего сайта.  

Шаг 2: Подтвердение владения доменом  
Следуйте инструкции по потверждению на странице, загрузите файл на свой сайт и нажмите «Подтвердить».  

Шаг 3: Детальное конфигурирование магазина  
- Заполните описание, выберите категорию и загрузите логотип.  
- В разделе настройки заполните Success URL, Fail URL, Status URL и Interaction URL. (см. рисунок 2)  
- На Interaction URL будут приходить автоматические уведомления об оплаченных ордерах.  
- Сохраните и ожидайте одобрения модератором.  

---

## Интеграция

Итак, вы зарегистрировались и создали магазин, теперь необходимо выполнить важный шаг – подготовить ваш сайт для взаимодействия с API Capitalist и настроить работу.  

### Форма запроса платежа

Эта HTML-форма является ключевой. С помощью нее вы можете отправить клиента на оплату. В ней передаются основные необходимые для этого параметры. Как видно из примера, для выбора языка интерфейса можно передать параметр запроса `lang=en` или `ru`.  

Также доступен `method="get"`, т.о. можно передать эти параметры в строке запроса.  

Отдельно есть API для создания ордера (см. ниже) с возможностью посмотреть сообщения об ошибках.  

#### Пример запроса

```html
<form name="payment" method="post" action="https://capitalist.net/merchant/pay?lang=en"
accept-charset="UTF-8">
  <input type="hidden" name="merchantid" value="70" />
  <input type="hidden" name="number" value="123981" />
  <input type="hidden" name="amount" value="15.23" />
  <input type="hidden" name="currency" value="USD" />
  <input type="hidden" name="description" value="My description" />
  <input type="hidden" name="sign" value="5ae3dbfdbac751f44355dedf5db59d02" />
</form>
```


---

## Параметры запроса

| Ключ | Имя | Формат | Пример | Описание |
| :-- | :-- | :-- | :-- | :-- |
| merchantid | Merchant ID | `/^\d+$/` | `70` | Идентификатор магазина. |
| number | Payment No. | `/^[A-Z\d\-]{1,42}$/i` | `123981` | Номер заказа. Сохраняется в биллинге Capitalist. Позволяет идентифицировать заказ в системе, а так же связать с заказами в вашем биллинге. Проверяется на уникальность для конкретного Merchant ID. Может содержать цифры, латинские буквы, дефис. |
| amount | Amount | `/^[\d\.]+$/` | `15.23` | Сумма заказа. Не более двух знаков после запятой для USD, EUR, RUR, USDT, USDTt. Не более 8 знаков после запятой для BTC. Минимум: 20 RUR, 0.1 USD/EUR, 0.001 BTC. Минимум для USDT (Trc20): 5 USD/USDT. Минимум для USDT (Erc20): 300 USD/USDT. |
| currency | Currency | `/^(USD\|EUR\|RUR\|BTC\|USDT\|USDTt\|USDTTRC20\|USDT-ERC20)$/` | `USD` | Валюта заказа. В зависимости от нее будет пополнен соответствующий счет, установленный в настройках магазина. Для включения приема биткоинов свяжитесь со службой поддержки. В этом случае валюта ордера должна быть BTC. Для USDT (Erc20) допустимые константы валюты: `USDT` или `USDTERC20`. Для USDT (Trc20) допустимые константы валюты: `USDTt` или `USDTTRC20`. |
| description | Description | `/^.{1,150}$/` | `Привет.` | Описание платежа. |
| sign | Sign | — | — | Цифровая подпись. См. формирование цифровой подписи. |

### Необязательные параметры `opt_*`

- `opt_email` — Preselected email. E-mail пользователя, необходимый на втором шаге.
- `opt_payway` — Preselected payway. Код способа платежа. Список кодов перечислен в конце этого документа.
- `opt_pc` — Preferred payment currency. Предпочитаемая валюта на втором шаге (в случае ее доступности и если передан `opt_payway`, сумма ордера на втором шаге будет отображаться в этой валюте). Декоративный параметр.
- `opt_lock_payway` — Lock payway.
    - `1` – менять способ оплаты запрещено
    - `0` (по-умолчанию) – менять способ оплаты возможно.
- `opt_cb_method` — `get` или `post`. Возврат пользователя на `success/fail/status` url будет проходить с передачей параметров выбранным методом (`get` или `post`, по умолчанию `post`).
- `opt_client_id` — Строка `^.{0,64}$`. Некоторый идентификатор вашего клиента.

---

## Формирование цифровой подписи

Цифровая подпись формируется путем объединения значений всех обязательных параметров формы. Параметры конкатенируются по алфавиту, т.е. для формы отправки запроса платежа в следующем порядке (по алфавиту): `amount`, `currency`, `description`, `merchantid`, `number`, `opt_email`.

Конкатенация идет через символ `:`. Если опциональные параметры `opt_*` не переданы, то в подписи не участвуют.

Полученное после объединения параметров значение хешируется методом HMAC-MD5, где в качестве секретного ключа используется «секретный ключ» магазина.

В результате, в параметре `sign` передается хеш-код в шестнадцатеричной кодировке в нижнем регистре.

Пример формирования ЭЦП на языке PHP (см. конец документа).

---

## API для создания ордера

Для создания ордера или просмотра ошибок создания, можно выполнить запрос (GET или POST) по адресу:

`https://capitalist.net/merchant/payGate/createorder`

Параметры запроса такие же, как в пункте «Форма запроса платежа».

### Пример запроса

```http
POST https://capitalist.net/merchant/payGate/createorder
Accept: application/json
Content-Type: application/json

{
  "merchantid": 163,
  "amount": 50,
  "number": "1657014969",
  "description": "test order creation",
  "currency": "USD",
  "sign": "mytestsign"
}
```


#### Неуспешный ответ

```json
{
  "errors": {
    "sign": "Неверная подпись."
  }
}
```


#### Успешный ответ

```json
{
  "order": {
    "description": "My demo payment.",
    "amount": 50,
    "currency": "USD",
    "number": "1677063939",
    "merchant": 163,
    "status": "NEW",
    "statusLocalized": "Ожидание платежа",
    "date": 1677063945,
    "email": null,
    "paid": false,
    "refunded": false,
    "chargedBack": false,
    "paymentUrl": "https://capitalist.net/merchant/order/163/1677063939",
    "convertedAmount": null,
    "convertedCurrency": null
  }
}
```


---

## Страницы возврата клиента

После оплаты платежный шлюз перенаправляет клиента на страницу возврата. На этой странице Capitalist пробует определить, основываясь на доступных данных, состояние платежа и в зависимости от него, перенаправить клиента на ту или иную страницу результата на сайте продавца (`Success URL`, `Fail URL`, `Status URL`, `Interaction URL`) соответственно.

### Параметры, передаваемые на страницы результата на сайте продавца

| Ключ | Имя | Пример | Описание |
| :-- | :-- | :-- | :-- |
| merchant_id | Merchant ID | `70` | Идентификатор магазина. |
| order_number | Payment No. | `123981` | Номер заказа. |
| payment_state | Payment state | `success` | Статус платежа. (Может принимать значения `success` или `fail`, `inprocess`). |
| payment_amount | Payment amount | `15.23` | Сумма платежа. |
| payment_currency | Payment currency | `USD` | Валюта платежа (USD, EUR, RUR). |
| sign | — | — | Цифровая подпись. |

При формировании цифровой подписи параметры конкатенируются по алфавиту, т.е. в следующем порядке: `merchant_id`, `order_number`, `payment_amount`, `payment_currency`, `payment_state`.

---

## Оповещение о платеже (Interaction URL)

При проведении платежа, Capitalist создает запрос с данными по нему на страницу взаимодействия (Interaction URL). В этом запросе содержатся все необходимые данные для завершения процесса оплаты заказа на вашем сайте.

### Проверка информации о платеже

Для исключения возможности компрометации оповещения о платеже на странице взаимодействия, вам необходимо реализовать его проверку.

#### Проверка источника данных

Необходимо удостовериться, что оповещение о платеже отправлено непосредственно Капиталистом и не скомпрометировано.

#### Проверка данных

Всегда проверяйте параметры в уведомлении о платеже:

- Идентификатор магазина (`merchant_id`)
- Номер заказа (`order_number`)
- Сумма платежа (`payment_amount`)
- Валюта платежа (`payment_currency`)
- Состояние платежа (`payment_state`). Должно быть значение `success`.
- Цифровая подпись (`sign`). См. формирование цифровой подписи.

---

## Проверка данных при помощи запроса к API

Для проверки статуса платежа по заказу, можно выполнить запрос (GET или POST) по адресу:

`https://capitalist.net/merchant/payGate/checkstate`

### Параметры запроса

| Параметр | Имя | Пример | Описание |
| :-- | :-- | :-- | :-- |
| merchant_id | Merchant ID | `70` | Идентификатор магазина. |
| order_number | Payment No. | `123981` | Номер заказа. |
| amount | Amount | `2.32` | Сумма к оплате. |
| currency | Currency | `USD` | Валюта заказа. |
| sign | — | — | Цифровая подпись. |

При формировании цифровой подписи параметры конкатенируются по алфавиту, т.е. в следующем порядке: `amount`, `currency`, `merchant_id`, `order_number`.

Переданные параметры должны соответствовать существующему заказу и подпись верна, в этом случае вернется статус заказа.

### Результат запроса

Результат возвращается в формате JSON.

- `success != false` – проверить статус заказа не удалось.
- `data.order.paid = true` – заказ оплачен.
- `convertedAmount` и `convertedCurrency` заполняются если при пополнении работает автоконвертация в другую валюту.


#### Пример успешного ответа и заказ оплачен

```json
{
  "success": true,
  "data": {
    "order": {
      "merchant_id": 70,
      "order_number": "1446466734",
      "description": "Мое назначение платежа.",
      "state": "paid",
      "paid": true,
      "payUrl": "https://capitalist.net/merchant/order/70/1446466734",
      "convertedAmount": 314.06,
      "convertedCurrency": "RUR"
    }
  }
}
```


#### Пример ответа, если не совпадает подпись

```json
{
  "success": false,
  "error": "Не удалось проверить подпись.",
  "data": {
    "errors": {
      "sign": [
        "Не удалось проверить подпись."
      ]
    }
  }
}
```


#### Пример ответа, если не удалось найти заказ или не совпадают его данные

```json
{
  "success": false,
  "error": "Не удалось проверить заказ.",
  "data": {
    "errors": {
      "sign": [
        "Не удалось проверить заказ."
      ]
    }
  }
}
```


---

## Расчет приблизительной суммы ордера в другой валюте

Для получения приблизительной суммы платежа, можно выполнить запрос (GET или POST) по адресу:

`https://capitalist.net/merchant/payGate/paywayinfo`

При обработке ответа, необходимо проверять, что `data.order != null`. (См. также параметр `opt_pc` в форме запроса платежа).

### Параметры запроса

| Параметр | Имя | Пример | Описание |
| :-- | :-- | :-- | :-- |
| merchant_id | Merchant ID | `70` | Идентификатор магазина. |
| amount | Amount | `71.94` | Сумма к оплате. |
| currency | Currency | `EUR` | Валюта заказа. |
| opt_payway | Selected payway | `mastercard` | Код способа платежа. |
| sign | — | — | Цифровая подпись. |

#### Пример запроса

```text
https://capitalist.net/merchant/payGate/paywayinfo?merchant_id=70&amount=71.94&currency=EUR&sign=b2053cea0a768666e7aa887e4dba9b44&opt_payway=mastercard
```


#### Пример ответа

```json
{
  "success": true,
  "data": {
    "target": {
      "amount": "71.94",
      "currency": "EUR"
    },
    "availablePaywayCurrencies": [
      "RUR",
      "EUR",
      "UAH",
      "USD"
    ],
    "order": {
      "merchantid": "70",
      "opt_payway": "mastercard",
      "amount": "5197.98",
      "currency": "RUR"
    }
  }
}
```


### Параметры ответа

- `availablePaywayCurrencies` — Список доступных валют на 2-м шаге оплаты.
- `order {}` — В случае невозможности подсчета или недоступности валюты, `data.order` может принимать значение `null`.
- `order.amount`, `order.currency` — Сумма и валюта для выставления счета.

---

## Пример подписи (либо проверки подписи) на PHP

```php
/**
 * Метод для подписи данных
 *
 * @param array $data Хеш-массив для подписи (например, $_POST)
 * @param string $secret Секретный ключ магазина
 *
 * @return string
 */
function signData($data, $secret)
{
    unset($data['sign']);
    ksort($data, SORT_STRING);
    $str = implode(':', $data);
    return hash_hmac('md5', $str, $secret);
}

$order = [
    'merchantid' => 85123,
    'number' => 'testorder123',
    'amount' => '12.34',
    'currency' => 'RUR',
    'description' => 'My demo payment.',
];

$order['sign'] = signData($order, 'mysecret123');

// var_dump($order):
//
// array (size=6)
// 'merchantid' => int 85123
// 'number' => string 'testorder123' (length=12)
// 'amount' => string '12.34' (length=5)
// 'currency' => string 'RUR' (length=3)
// 'description' => string 'My demo payment.' (length=16)
// 'sign' => string '8bb5946e96999f81f8958a8c79d50d4b' (length=32)
```


---

## Отмена ордера

Выставленный ордер можно отменить в любой момент при помощи ручки:

`https://capitalist.net/merchant/payGate/cancel`

При успешной отмене ответ будет с кодом 200, иначе 422. В теле ответа возвращается JSON с деталями ордера. Отменить можно только неоплаченный ордер.

### Параметры запроса

| Параметр | Пример | Описание |
| :-- | :-- | :-- |
| merchantId | `70` | Идентификатор магазина. |
| orderNumber | `1234589` | Номер ордера. |
| signature | — | Цифровая подпись. |

Как и в других местах ранее, все параметры (их значения) запроса, за исключением `signature`, конкатенируются через двоеточие в одну строку. Порядок — по алфавиту имен параметров.

Полученное после объединения параметров значение хешируется методом HMAC-MD5, где в качестве секретного ключа используется «секретный ключ» магазина:

`Hash_HMAC-MD5("<merchantId>:<orderNumber>", <merchantSecret>)`

Итоговую строку передаем как `signature`.

Допускается как GET c query-параметрами, так и POST (`application/x-www-form-urlencoded`, `application/json`).

### Пример запроса

```http
POST https://capitalist.net/merchant/payGate/cancel
Accept: application/json
Content-Type: application/json

{
  "merchantId": 163,
  "orderNumber": 1665130908,
  "signature": " b2053cea0a768666e7aa887e4dba9b44"
}
```


### Пример ответа

```json
{
  "order": {
    "description": "My demo payment.",
    "amount": 20,
    "currency": "RUR",
    "number": "1665130908",
    "merchant": 163,
    "status": "CANCELLED",
    "statusLocalized": "CANCELLED",
    "date": 1665130909,
    "created": true,
    "email": null,
    "paid": false,
    "paymentUrl": "https://capitalist.net/merchant/order/163/1665130908"
  }
}
```


---

## Рекуррентный платеж по подписке

Рекуррентный платеж по активной подписке инициируется мерчантом при помощи ручки:

`https://capitalist.net/merchant/subscription/payment`

При успешном списании ответ будет с кодом 200, иначе 422.

### Параметры запроса

| Параметр | Пример | Описание |
| :-- | :-- | :-- |
| merchantId | `70` | Идентификатор магазина. |
| subscriptionId | `a11163f0-463c11ed-8b5d7bc897aeac86` | ID подписки. |
| timestamp | `16652007860000` | Метка времени. |
| signature | — | Цифровая подпись. |

Как и в других местах ранее, все параметры (их значения) запроса, за исключением `signature`, конкатенируются через двоеточие в одну строку. Порядок — по алфавиту имен параметров.

`Hash_HMAC-MD5("<merchantId>:<subscriptionId>:<timestamp>", <merchantSecret>)`

Итоговую строку передаем как `signature`.

Допускается как GET c query-параметрами, так и POST (`application/x-www-form-urlencoded`, `application/json`).

### Пример запроса

```http
POST https://capitalist.net/merchant/subscription/payment
Accept: application/json
Content-Type: application/json

{
  "merchantId": 163,
  "subscriptionId": "a11163f0-463c-11ed-8b5d-7bc897aeac86",
  "timestamp": "16652007860000",
  "signature": "fa69d5568b8b9e2836000fa9d70abef2"
}
```


### Пример ответа

```json
{
  "success": true
}
```


---

## Отмена подписки

Активную подписку можно отменить в любой момент при помощи ручки:

`https://capitalist.net/merchant/subscription/cancel`

При успешной отмене ответ будет с кодом 200, иначе 422.

### Параметры запроса

| Параметр | Пример | Описание |
| :-- | :-- | :-- |
| merchantId | `70` | Идентификатор магазина. |
| subscriptionId | `a11163f0-463c11ed-8b5d7bc897aeac86` | ID подписки. |
| timestamp | `16652007860000` | Метка времени. |
| signature | — | Цифровая подпись. |

Формирование `signature` аналогично рекуррентному платежу:

`Hash_HMAC-MD5("<merchantId>:<subscriptionId>:<timestamp>", <merchantSecret>)`

### Пример запроса

```http
POST https://capitalist.net/merchant/subscription/cancel
Accept: application/json
Content-Type: application/json

{
  "merchantId": 163,
  "subscriptionId": "a11163f0-463c-11ed-8b5d-7bc897aeac86",
  "timestamp": "16652007860000",
  "signature": "fa69d5568b8b9e2836000fa9d70abef2"
}
```


### Пример ответа

```json
{
  "success": true
}
```


---

## Список подписок (подписчиков)

Список активных подписок в постраничном режиме можно получить при помощи ручки:

`https://capitalist.net/merchant/subscription/list`

Возвращает общее количество `total` и список `subscriptions: {total: [int], subscriptions: {obj}}`.

### Параметры запроса

| Параметр | Пример | Описание |
| :-- | :-- | :-- |
| merchantId | `70` | Идентификатор магазина. |
| limit | `1` | Количество подписок на странице. |
| offset | `0` | Смещение страницы. |
| timestamp | `16652007860000` | Метка времени. |
| signature | — | Цифровая подпись. |

Формирование подписи по аналогии с предыдущими примерами.

### Пример запроса

```http
POST http://localhost:8050/merchant/subscription/list
Accept: application/json
Content-Type: application/json

{
  "merchantId": 374,
  "timestamp": "16652007860000",
  "limit": 1,
  "offset": 0,
  "signature": "fa69d5568b8b9e2836000fa9d70abef2"
}
```


### Пример ответа

```json
{
  "success": true,
  "subscriptions": [
    {
      "id": "dda214c4-7a1f-11ed-8b5d-c76b09b23a0a",
      "subscriptionId": "dda214c4-7a1f-11ed-8b5d-c76b09b23a0a",
      "productId": "d19986cc-4562-11ed-8b5d-2f5a48c6e4f5",
      "product": {
        "id": "d19986cc-4562-11ed-8b5d-2f5a48c6e4f5",
        "name": "Подпииисочкаааа",
        "shortDescription": "Моя хорошая подписулечка",
        "merchantId": 374,
        "period": "month",
        "price": "10",
        "currency": "USD"
      },
      "status": "new",
      "nextUpdate": 1673470800,
      "nextUpdateFormatted": "2023-01-11 21:00:00",
      "orders": [
        "10101792"
      ],
      "email": "myclient@example.com",
      "clientId": "myclient@example.com",
      "merchantId": 374,
      "lastPayments": [],
      "lastPaymentDate": null
    }
  ],
  "total": 3
}
```


---

## Список кодов платежных систем

В необязательном параметре `opt_payway` (см. выше) можно передать код выбранной платежной системы. Пользователь будет перенаправлен сразу на следующий шаг оплаты в соответствии с выбранной системой.

### Список всех кодов (в JSON)

`https://capitalist.net/merchant/payGate/payways?all=1`

### Список кодов, отфильтрованных для конкретного магазина, суммы и валюты

`https://capitalist.net/merchant/payGate/payways?merchantid=70&amount=2.32&currency=USD`

#### Пример ответа

```json
{
  "success": true,
  "data": {
    "payways": [
      {
        "code": "capitalist",
        "name": "Capitalist.net"
      },
      {
        "code": "webmoney",
        "name": "WebMoney"
      },
      {
        "code": "yandexmoney",
        "name": "Яндекс.Деньги"
      },
      {
        "code": "epese",
        "name": "EPESE"
      }
    ]
  }
}
```


---

## Запрос курсов валют

Некоторые способы оплаты доступны только для ордеров в определенной валюте. Например, для оплаты Bitcoin переводом, необходимо выставить ордер в валюте BTC. Для расчета эквивалентной суммы платежа, необходимо получить курс системы.

Для этого существует ручка:

`/merchant/payGate/currencyrate`

### Курс валютной пары (в JSON)

```http
GET https://capitalist.net/merchant/payGate/currencyrate
```


### Параметры запроса

| Параметр | Имя | Пример | Описание |
| :-- | :-- | :-- | :-- |
| merchantid | Merchant ID | `70` | Идентификатор магазина. |
| amount | Amount | `71.94` | Сумма. |
| currency | Currency | `USD` | Валюта. |
| opt_pc | Destination currency | `BTC` | Валюта. |

Для этого запроса формировать подпись не требуется.

#### Пример ответа

```json
{
  "data": {
    "sell": [
      {
        "comment": "sell USD for BTC to capitalist",
        "pair": "USD/BTC",
        "sellAmount": "500",
        "sellCurrency": "USD",
        "amount": 0.051175,
        "currency": "BTC"
      }
    ],
    "buy": [
      {
        "comment": "buy USD for BTC from capitalist",
        "pair": "USD/BTC",
        "buyAmount": "500",
        "buyCurrency": "USD",
        "amount": 0.0544,
        "currency": "BTC"
      }
    ]
  }
}
```


---

## История последних изменений

1.12 от 16.06.2023

- Удалены устаревшие скриншоты с регистрации мерчанта
- Удалена совсем старая история изменений

1.11 от 22.02.2023

- Added order creation API (`payGate/createorder`)

1.10 от 12.12.2022

- Subscriptions API: subscriptions list added

1.9 от 10.10.2022

- Subscriptions API added (Cancellation and Recurrent payments)

1.8 от 07.10.2022

- Order cancellation added to API.

1.7.6 от 17.05.2022

- USDT Erc20 and Trc20 limits added:
    - Payment method USDT Erc20 available for orders with amount >= 300 USD/USDT/USDTt
    - Payment method USDT Trc20 available for orders with amount >= 5 USD/USDT/USDTt

```

Сохранить можно, например, через редактор как `capitalist.merchant.md`.[^1_1]


<div align="center">⁂</div>

[^1_1]: file:///C:/Users/PC/Downloads/capitalist.merchant.pdf```

